/**
 * crocos.js
 *
 * @author  Keisuke SATO <sato@crocos.co.jp>
 * @license MIT License
 */(function(a,b,c){var d=a.crocos={},e=[];d.util=d.utils={},d.util.nl2br=function(a){return a.replace(/\n/g,"<br />\n")},d.util.truncate=function(a,b,c){return c=c!=null?c:"..",a.length<=b&&(c=""),a.slice(0,b-c.length)+c},d.util.redirect=function(a){if(window.location!=null)return window.location=a},d.wait=function(c){var e=new b.Deferred,f=function(){return c=="FB"&&c in a&&d.facebook.initialized?e.resolve(a[c]):c in a&&c!="FB"?e.resolve(a[c]):setTimeout(function(){return f()},100)};return f(),e.promise()},d.logger=function(a){arguments.length===1?e[e.length]=a:e[e.length]=arguments},d.logger.flush=function(a){console!==c&&console.log!==c&&console.log(e);if(a)return e=[]},d.cache={},d.cache.enabled=a.localStorage!==c,d.cache.get=function(c,e){if(!d.cache.enabled)throw"localStorage is not enabled";var f,g;g=a.localStorage.getItem(c),e=b.extend({},e);if(g){g=JSON.parse(g);if("data"in g){if(e.expire){f=new Date;if(g.created_at==null||new Date(f.getTime()-e.expire*1e3)>g.created_at)throw"cache. "+c+" was expired"}return g.data}throw"cache. "+c+" not found"}throw"cache. "+c+" not found"},d.cache.set=function(b,c){if(!d.cache.enabled)throw"localStorage is not enabled";var e;e=JSON.stringify({created_at:(new Date).getTime(),data:c});try{return a.localStorage.setItem(b,e)}catch(f){return d.logger("cache. reflesh cache"),a.localStorage.clear(),a.localStorage.setItem(b,e)}},d.cache.has=function(a,b){try{return d.cache.get(a,b),!0}catch(c){return!1}},d.cache["with"]=function(a,c,e){var f;return f=new b.Deferred,setTimeout(function(){d.cache.has(a)?f.resolve(d.cache.get(a)):c(new b.Deferred).done(function(b){return d.cache.set(a,b),f.resolve(b)})},0),f.promise()},d.facebook={initialized:!1},d.facebook.ready=function(){return d.wait("FB")};var f={};f.setText=function(a,b){return a.text(b),a.addClass("fbx-processed")},f.graph_do=function(){var a,c;a=b(".fbx-graph:not(.fbx-processed)"),c=[],a.each(function(){var a,d,e,g,h;h=b(this),g=h.data("fbx-id"),e=h.data("fbx-field"),a="fbx_graph_"+g;if(cache.has(a,{expire:3600})){d=cache.get(a);if(d!=null&&e in d)return f.setText(h,d[e])}else if(g!=null)return c[c.length]=g});if(c.length)return FB.api("?locale="+d.locale+"&ids="+c.join(","),function(c){return b.each(c,function(a,b){return cache.set("fbx_graph_"+a,b)}),a.each(function(){var a,d,e;e=b(this),d=e.data("fbx-id"),a=e.data("fbx-field");if(d in c&&a in c[d])return f.setText(e,c[d][a])})})},f.like_count_do=function(){var a,c,d;c=b(".fbx-like-count:not(.fbx-processed)"),d=[],a={},c.each(function(){var a;return a=b(this),d[d.length]=a.data("fbx-url")});if(d.length)return FB.api({method:"fql.query",query:"SELECT url, like_count FROM link_stat WHERE url IN ('"+d.join("','")+"')"},function(d){var e,g,h;for(g=0,h=d.length;g<h;g++)e=d[g],"url"in e&&"like_count"in e&&(a[e.url]=e.like_count);return c.each(function(){var c,d;c=b(this),d=c.data("fbx-url");if(d in a){f.setText(c,a[d]);if(parseInt(a[d],10)===0)return c.addClass("fbx-like-count-zero")}})})},d.facebook.fbx=function(){f.graph_do(),f.like_count_do()},b(function(){b("html").addClass(window.top===window.self?"self-frame":"in-frame"),d.wait("FB").done(function(a){return d.facebook.fbx(),a.getLoginStatus(function(a){if("status"in a)return b("html").addClass("fbstatus-"+a.status)})}),setTimeout(function(){d.facebook.initialized=!0},5e3)})})(this,jQuery);